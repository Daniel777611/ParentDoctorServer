<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Torahnest Health - Main Interface</title>
  <style>
    :root {
      --bg: #f5f5f5;
      --card: #fff;
      --border: #e5e5e5;
      --text: #222;
      --muted: #666;
      --accent: #222;
      --success: #16a34a;
      --blue: #3b82f6;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }
    .container {
      display: grid;
      grid-template-columns: var(--left-panel-width, 1fr) 4px 80px var(--right-panel-width, 1fr);
      gap: 0;
      padding: 20px;
      height: 100vh;
      max-width: 1800px;
      margin: 0 auto;
      position: relative;
    }
    
    /* Left Panel */
    .panel-left {
      display: grid;
      grid-template-rows: auto var(--video-area-height, 1fr) 4px var(--ai-sections-height, 1fr);
      background: var(--card);
      border-right: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    
    /* Video Area Wrapper - contains video area and connected state elements */
    .video-area-wrapper {
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    /* Waiting State - Doctor Avatar Section */
    .waiting-avatar-section {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid var(--border);
    }
    .waiting-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 32px;
      position: relative;
      overflow: hidden;
    }
    .waiting-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .waiting-avatar-upload-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 24px;
      height: 24px;
      background: var(--accent);
      color: #fff;
      border: 2px solid #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .waiting-avatar:hover .waiting-avatar-upload-btn {
      opacity: 1;
    }
    /* Waiting State - Video Call Area */
    .video-call-area {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--card);
      min-height: 200px;
      position: relative;
      overflow: hidden;
    }
    .video-call-area.connected {
      background: var(--card);
      min-height: auto;
    }
    .waiting-text {
      color: var(--muted);
      font-size: 16px;
      font-weight: 500;
    }
    
    /* Incoming Call Overlay */
    .incoming-call-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .incoming-call-content {
      background: var(--card);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    .incoming-call-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      font-weight: 600;
      margin: 0 auto 20px;
      border: 4px solid var(--success);
    }
    .incoming-call-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .incoming-call-info {
      margin-bottom: 30px;
    }
    .incoming-call-name {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }
    .incoming-call-status {
      font-size: 16px;
      color: var(--muted);
    }
    .incoming-call-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
    }
    .call-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 24px;
      font-weight: 600;
      transition: transform 0.2s, opacity 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .call-btn:hover {
      transform: scale(1.1);
    }
    .call-btn:active {
      transform: scale(0.95);
    }
    .call-btn.reject-btn {
      background: #ef4444;
      color: #fff;
    }
    .call-btn.accept-btn {
      background: var(--success);
      color: #fff;
    }
    .call-btn-icon {
      font-size: 32px;
      margin-bottom: 4px;
    }
    .call-btn-label {
      font-size: 12px;
      font-weight: 500;
    }
    
    /* Connected State - Doctor Info */
    .doctor-header {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }
    .doctor-avatar {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }
    .doctor-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }
    .avatar-upload-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 20px;
      height: 20px;
      background: var(--accent);
      color: #fff;
      border: 2px solid #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .doctor-avatar:hover .avatar-upload-btn {
      opacity: 1;
    }
    .avatar-upload-input {
      display: none;
    }
    .doctor-info {
      flex: 1;
    }
    .doctor-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .doctor-status {
      font-size: 12px;
      color: var(--success);
      font-weight: 500;
    }
    
    /* Patient Image */
    .patient-image-container {
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .patient-image {
      width: 100%;
      max-width: 500px;
      border-radius: 12px;
      border: 2px solid var(--blue);
      object-fit: cover;
      display: none;
    }
    .patient-image.visible {
      display: block;
    }
    
    /* Audio Controls Bar */
    .audio-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 20px;
      background: #e5e5e5;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }
    .audio-icon {
      font-size: 20px;
      color: var(--muted);
    }
    .language-btn {
      padding: 8px 16px;
      background: #e5e5e5;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
    }
    .speaker-icon {
      font-size: 20px;
      color: var(--muted);
    }
    
    /* Left Panel Vertical Resizer */
    .resizer-left-vertical {
      height: 4px;
      background: var(--border);
      cursor: row-resize;
      position: relative;
      z-index: 10;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }
    .resizer-left-vertical:hover {
      background: var(--accent);
    }
    .resizer-left-vertical.dragging {
      background: var(--accent);
      transition: none;
    }
    .resizer-left-vertical.dragging ~ * {
      transition: none;
    }
    .resizer-left-vertical::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: -2px;
      bottom: -2px;
      cursor: row-resize;
    }
    
    /* AI Sections */
    .ai-sections {
      display: flex;
      flex-direction: column;
      min-height: 200px;
      position: relative;
      overflow: hidden;
      background: var(--card);
    }
    
    /* Audio Controls Bar - part of AI sections */
    .ai-sections .audio-controls {
      flex-shrink: 0;
      order: -1; /* Place at the top of AI sections */
    }
    
    /* AI Sections Content */
    .ai-sections-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }
    .ai-section {
      background: var(--card);
      padding: 16px;
    }
    .ai-section:first-child {
      border-right: 1px solid var(--border);
      padding-right: 20px;
    }
    .ai-section:last-child {
      padding-left: 20px;
    }
    .ai-section h4 {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    .ai-section p {
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
      margin: 0;
    }
    .ai-section > div {
      min-height: 20px;
    }
    .ai-section ul {
      margin: 0;
      padding-left: 20px;
      list-style: none;
    }
    .ai-section ul:empty {
      padding: 0;
    }
    .ai-section li {
      font-size: 14px;
      line-height: 1.8;
      color: var(--text);
    }
    
    /* Resizer Handle */
    .resizer {
      width: 4px;
      background: var(--border);
      cursor: col-resize;
      position: relative;
      z-index: 10;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }
    .resizer:hover {
      background: var(--accent);
    }
    .resizer.dragging {
      background: var(--accent);
      transition: none;
    }
    .resizer.dragging ~ * {
      transition: none;
    }
    .resizer::before {
      content: '';
      position: absolute;
      left: -2px;
      right: -2px;
      top: 0;
      bottom: 0;
      cursor: col-resize;
    }
    
    /* Center Controls */
    .panel-center {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 20px;
      position: relative;
    }
    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: transform 0.2s ease, opacity 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .control-btn:hover {
      transform: scale(1.1);
    }
    .control-btn:active {
      transform: scale(0.95);
    }
    .control-btn.video {
      background: var(--accent);
      color: #fff;
    }
    .control-btn.mic {
      background: var(--accent);
      color: #fff;
    }
    .control-btn.hangup {
      background: #ef4444;
      color: #fff;
    }
    .control-btn.active {
      opacity: 0.7;
    }
    
    /* Right Panel */
    .panel-right {
      display: grid;
      grid-template-rows: var(--report-section-height, 1fr) 4px var(--chat-section-height, 1fr);
      background: var(--card);
      overflow: hidden;
      position: relative;
    }
    
    /* Vertical Resizer Handle */
    .resizer-vertical {
      height: 4px;
      background: var(--border);
      cursor: row-resize;
      position: relative;
      z-index: 10;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }
    .resizer-vertical:hover {
      background: var(--accent);
    }
    .resizer-vertical.dragging {
      background: var(--accent);
      transition: none;
    }
    .resizer-vertical.dragging ~ * {
      transition: none;
    }
    .resizer-vertical::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: -2px;
      bottom: -2px;
      cursor: row-resize;
    }
    
    /* AI Summary Report */
    .report-section {
      background: var(--card);
      padding: 20px;
      overflow-y: auto;
      min-height: 200px;
      position: relative;
    }
    .report-section h4 {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }
    .report-section #summaryReport {
      min-height: 20px;
    }
    .report-section p {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 12px;
      color: var(--text);
    }
    .report-section p:last-child {
      margin-bottom: 0;
    }
    .report-section p:has(span:empty) {
      display: none;
    }
    .report-section p:has(+ ul:empty) {
      display: none;
    }
    .report-section p:empty:not(.report-note) {
      display: none;
    }
    .report-section strong {
      font-weight: 600;
      color: var(--text);
    }
    .report-section span:empty {
      display: none;
    }
    .report-section ul {
      margin: 8px 0 12px 20px;
      padding: 0;
      list-style: none;
    }
    .report-section ul:empty {
      margin: 0;
      display: none;
    }
    .report-section ul:empty + p {
      display: none;
    }
    .report-section li {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 4px;
    }
    .report-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 16px;
      font-style: italic;
      display: none;
    }
    .report-section:has(#reportSummary:not(:empty)) .report-note {
      display: block;
    }
    
    /* Chat History */
    .chat-section {
      background: var(--card);
      padding: 20px;
      overflow-y: auto;
      min-height: 200px;
      position: relative;
    }
    .chat-section h4 {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }
    .chat-message {
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
    }
    .chat-message.patient {
      background: #e5e5e5;
      color: var(--text);
    }
    .chat-message.ai {
      background: #fff;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .chat-message.doctor {
      background: #dcfce7;
      border-left: 3px solid var(--success);
      color: var(--text);
    }
    .chat-message strong {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    .chat-message ul {
      margin: 8px 0 0 20px;
      padding: 0;
    }
    .chat-message li {
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 4px;
    }
    
    /* State Management */
    .state-waiting .doctor-header,
    .state-waiting .patient-image-container {
      display: none;
    }
    .state-waiting .waiting-avatar-section {
      display: flex;
    }
    .state-waiting .video-call-area {
      display: flex;
      flex: 1;
    }
    .state-connected .waiting-text {
      display: none;
    }
    .state-connected .waiting-avatar-section {
      display: none;
    }
    .state-connected .video-call-area {
      display: none;
    }
    .state-connected .video-area-wrapper {
      display: flex;
      flex-direction: column;
    }
    /* Hide center controls in waiting state */
    .state-waiting .panel-center {
      display: none;
    }
    /* Adjust grid layout when waiting */
    .state-waiting .container {
      grid-template-columns: var(--left-panel-width, 1fr) 4px var(--right-panel-width, 1fr);
    }
    .state-waiting .resizer {
      display: block;
    }
    .state-waiting .panel-center {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Left Panel -->
    <div class="panel-left">
      <!-- Waiting State: Doctor Avatar -->
      <div class="waiting-avatar-section" id="waitingAvatarSection">
        <div class="waiting-avatar" id="waitingAvatar">
          <span id="waitingAvatarInitials">D</span>
          <input type="file" id="waitingAvatarUploadInput" class="avatar-upload-input" accept="image/*" />
          <div class="waiting-avatar-upload-btn" id="waitingAvatarUploadBtn" title="Upload photo">üì∑</div>
        </div>
      </div>
      
      <!-- Video Area Wrapper -->
      <div class="video-area-wrapper">
        <!-- Waiting State: Video Call Area -->
        <div class="video-call-area waiting" id="videoCallArea">
          <div class="waiting-text" id="waitingText">Waiting for video call</div>
          <div style="position: absolute; bottom: 20px; left: 20px; font-size: 12px; color: #666; background: rgba(255,255,255,0.8); padding: 8px; border-radius: 4px;">
            <div>Doctor ID: <span id="displayDoctorId" style="font-weight: bold;">-</span></div>
            <div>WebSocket: <span id="displayWsStatus" style="font-weight: bold;">-</span></div>
          </div>
        </div>
        
        <!-- Incoming Call Notification -->
        <div class="incoming-call-overlay" id="incomingCallOverlay" style="display: none;">
          <div class="incoming-call-content">
            <div class="incoming-call-avatar" id="incomingCallAvatar">
              <span id="incomingCallInitials">P</span>
            </div>
            <div class="incoming-call-info">
              <div class="incoming-call-name" id="incomingCallName">Incoming Call</div>
              <div class="incoming-call-status" id="incomingCallStatus">Parent is calling...</div>
            </div>
            <div class="incoming-call-buttons">
              <button class="call-btn reject-btn" id="rejectCallBtn">
                <span class="call-btn-icon">‚úï</span>
                <span class="call-btn-label">Reject</span>
              </button>
              <button class="call-btn accept-btn" id="acceptCallBtn">
                <span class="call-btn-icon">‚úì</span>
                <span class="call-btn-label">Accept</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Connected State: Video Streams -->
        <div class="connected-video-container" id="connectedVideoContainer" style="display: none; position: relative; width: 100%; height: 100%; background: #000;">
          <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; background: #000;"></video>
          <video id="localVideo" autoplay playsinline muted style="position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #fff; background: #000; z-index: 10;"></video>
        </div>
        
        <!-- Connected State: Doctor Header -->
        <div class="doctor-header" id="doctorHeader">
          <div class="doctor-avatar" id="doctorAvatar">
            <span id="avatarInitials">D</span>
            <input type="file" id="avatarUploadInput" class="avatar-upload-input" accept="image/*" />
            <div class="avatar-upload-btn" id="avatarUploadBtn" title="Upload photo">üì∑</div>
          </div>
          <div class="doctor-info">
            <div class="doctor-name" id="doctorName">Dr. Loading...</div>
            <div class="doctor-status" id="doctorStatus">Connected</div>
          </div>
        </div>
        
        <!-- Connected State: Patient Image -->
        <div class="patient-image-container" id="patientImageContainer">
          <img src="https://images.unsplash.com/photo-1503454537195-1dcabb73ffb9?w=500&h=400&fit=crop" 
               alt="Patient" 
               class="patient-image" 
               id="patientImage">
        </div>
        
      </div>
      
      <!-- Left Panel Vertical Resizer Handle -->
      <div class="resizer-left-vertical" id="resizerLeftVertical"></div>
      
      <!-- AI Sections -->
      <div class="ai-sections">
        <!-- Audio Controls Bar -->
        <div class="audio-controls">
          <span class="audio-icon">üëÇ</span>
          <button class="language-btn" id="languageBtn">English</button>
          <span class="speaker-icon">üîä</span>
        </div>
        
        <!-- AI Sections Content -->
        <div class="ai-sections-content">
          <div class="ai-section">
            <h4>AI Real-time Interpreter</h4>
            <div id="interpreterText"></div>
          </div>
          <div class="ai-section">
            <h4>AI Symptom Summary</h4>
            <ul id="symptomList"></ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Resizer Handle -->
    <div class="resizer" id="resizer"></div>
    
    <!-- Center Controls -->
    <div class="panel-center">
      <button class="control-btn video" id="videoBtn" title="Toggle Video">üìπ</button>
      <button class="control-btn mic" id="micBtn" title="Toggle Microphone">üé§</button>
      <button class="control-btn hangup" id="hangupBtn" title="End Call">‚úï</button>
    </div>
    
    <!-- Right Panel -->
    <div class="panel-right">
      <!-- AI Summary Report -->
      <div class="report-section">
        <h4>AI Summary Report</h4>
        <div id="summaryReport">
          <p><strong>Patient:</strong> <span id="reportPatient"></span></p>
          <p><strong>Reported Symptoms:</strong></p>
          <ul id="reportSymptoms"></ul>
          <p><strong>Parent's Concern:</strong></p>
          <p id="reportConcern"></p>
          <p id="reportSummary"></p>
          <p class="report-note">(Auto-generated from AI-Patient conversation)</p>
        </div>
      </div>
      
      <!-- Vertical Resizer Handle -->
      <div class="resizer-vertical" id="resizerVertical"></div>
      
      <!-- AI-Patient Chat History -->
      <div class="chat-section">
        <h4>AI-Patient Chat History</h4>
        <div id="chatHistory">
          <!-- Chat messages will be dynamically added here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Check if doctor is logged in
    if (!sessionStorage.getItem('doctorLoggedIn')) {
      window.location.href = '/signin.html';
    }

    // Resizable Panels
    (function() {
      const resizer = document.getElementById('resizer');
      const container = document.querySelector('.container');
      let isResizing = false;
      let startX = 0;
      let startLeftWidth = 0;
      let startRightWidth = 0;
      let rafId = null;

      // Load saved panel widths
      const savedLeftWidth = localStorage.getItem('leftPanelWidth');
      const savedRightWidth = localStorage.getItem('rightPanelWidth');
      if (savedLeftWidth && savedRightWidth) {
        document.documentElement.style.setProperty('--left-panel-width', savedLeftWidth);
        document.documentElement.style.setProperty('--right-panel-width', savedRightWidth);
      }

      function startResize(e) {
        isResizing = true;
        resizer.classList.add('dragging');
        
        // Get container position
        const containerRect = container.getBoundingClientRect();
        
        // Store initial resizer position relative to container
        const resizerRect = resizer.getBoundingClientRect();
        startX = resizerRect.left + resizerRect.width / 2 - containerRect.left;
        
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      }

      function resize(e) {
        if (!isResizing) return;
        
        // Cancel previous animation frame
        if (rafId) {
          cancelAnimationFrame(rafId);
        }
        
        // Use requestAnimationFrame for smooth updates
        rafId = requestAnimationFrame(() => {
          const containerRect = container.getBoundingClientRect();
          // Check if center panel is visible
          const centerPanel = document.querySelector('.panel-center');
          const centerPanelWidth = centerPanel && centerPanel.offsetParent !== null ? 80 : 0;
          const resizerWidth = 4;
          const availableWidth = containerRect.width - centerPanelWidth - resizerWidth;
          
          // Calculate mouse position relative to container
          const mouseX = e.clientX - containerRect.left;
          
          // Calculate new left width based on mouse position
          let newLeftWidth = mouseX;
          const minWidth = availableWidth * 0.2;
          const maxWidth = availableWidth * 0.8;
          
          // Clamp to min/max but always update to follow mouse
          newLeftWidth = Math.max(minWidth, Math.min(maxWidth, newLeftWidth));
          const newRightWidth = availableWidth - newLeftWidth;
          
          // Always update position to follow mouse
          const leftPercent = (newLeftWidth / availableWidth) * 100;
          const rightPercent = (newRightWidth / availableWidth) * 100;
          
          document.documentElement.style.setProperty('--left-panel-width', `${leftPercent}%`);
          document.documentElement.style.setProperty('--right-panel-width', `${rightPercent}%`);
        });
      }
      
      function stopResize() {
        if (!isResizing) return;
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        isResizing = false;
        resizer.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        
        // Save to localStorage on stop
        const containerRect = container.getBoundingClientRect();
        const centerPanel = document.querySelector('.panel-center');
        const centerPanelWidth = centerPanel && centerPanel.offsetParent !== null ? 80 : 0;
        const resizerWidth = 4;
        const availableWidth = containerRect.width - centerPanelWidth - resizerWidth;
        const leftPanel = document.querySelector('.panel-left');
        const leftRect = leftPanel.getBoundingClientRect();
        const leftPercent = ((leftRect.width) / availableWidth) * 100;
        const rightPercent = 100 - leftPercent;
        
        localStorage.setItem('leftPanelWidth', `${leftPercent}%`);
        localStorage.setItem('rightPanelWidth', `${rightPercent}%`);
      }

      resizer.addEventListener('mousedown', startResize);
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
      document.addEventListener('mouseleave', stopResize);
    })();

    // Resizable Vertical Panels (Right Panel)
    (function() {
      const resizerVertical = document.getElementById('resizerVertical');
      const rightPanel = document.querySelector('.panel-right');
      let isResizing = false;
      let startY = 0;
      let startReportHeight = 0;
      let startChatHeight = 0;
      let rafId = null;

      // Load saved panel heights
      const savedReportHeight = localStorage.getItem('reportSectionHeight');
      const savedChatHeight = localStorage.getItem('chatSectionHeight');
      if (savedReportHeight && savedChatHeight) {
        document.documentElement.style.setProperty('--report-section-height', savedReportHeight);
        document.documentElement.style.setProperty('--chat-section-height', savedChatHeight);
      }

      function startResizeVertical(e) {
        isResizing = true;
        resizerVertical.classList.add('dragging');
        
        // Get panel position
        const rightPanelRect = rightPanel.getBoundingClientRect();
        
        // Store initial resizer position relative to panel
        const resizerRect = resizerVertical.getBoundingClientRect();
        startY = resizerRect.top + resizerRect.height / 2 - rightPanelRect.top;
        
        document.body.style.cursor = 'row-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      }

      function resizeVertical(e) {
        if (!isResizing) return;
        
        // Cancel previous animation frame
        if (rafId) {
          cancelAnimationFrame(rafId);
        }
        
        // Use requestAnimationFrame for smooth updates
        rafId = requestAnimationFrame(() => {
          const rightPanelRect = rightPanel.getBoundingClientRect();
          const resizerHeight = 4;
          const availableHeight = rightPanelRect.height - resizerHeight;
          
          // Calculate mouse position relative to panel
          const mouseY = e.clientY - rightPanelRect.top;
          
          // Calculate new report height based on mouse position
          let newReportHeight = mouseY;
          const minHeight = availableHeight * 0.2;
          const maxHeight = availableHeight * 0.8;
          
          // Clamp to min/max but always update to follow mouse
          newReportHeight = Math.max(minHeight, Math.min(maxHeight, newReportHeight));
          const newChatHeight = availableHeight - newReportHeight;
          
          // Always update position to follow mouse
          const reportPercent = (newReportHeight / availableHeight) * 100;
          const chatPercent = (newChatHeight / availableHeight) * 100;
          
          document.documentElement.style.setProperty('--report-section-height', `${reportPercent}%`);
          document.documentElement.style.setProperty('--chat-section-height', `${chatPercent}%`);
        });
      }
      
      function stopResizeVertical() {
        if (!isResizing) return;
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        isResizing = false;
        resizerVertical.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        
        // Save to localStorage on stop
        const rightPanelRect = rightPanel.getBoundingClientRect();
        const resizerHeight = 4;
        const availableHeight = rightPanelRect.height - resizerHeight;
        const reportSection = document.querySelector('.report-section');
        const reportRect = reportSection.getBoundingClientRect();
        const reportPercent = ((reportRect.height) / availableHeight) * 100;
        const chatPercent = 100 - reportPercent;
        
        localStorage.setItem('reportSectionHeight', `${reportPercent}%`);
        localStorage.setItem('chatSectionHeight', `${chatPercent}%`);
      }

      resizerVertical.addEventListener('mousedown', startResizeVertical);
      document.addEventListener('mousemove', resizeVertical);
      document.addEventListener('mouseup', stopResizeVertical);
      document.addEventListener('mouseleave', stopResizeVertical);
    })();

    // Resizable Left Panel Vertical (Video Area and AI Sections)
    (function() {
      const resizerLeftVertical = document.getElementById('resizerLeftVertical');
      const leftPanel = document.querySelector('.panel-left');
      let isResizing = false;
      let startY = 0;
      let startVideoHeight = 0;
      let startAiHeight = 0;

      // Load saved panel heights
      const savedVideoHeight = localStorage.getItem('videoAreaHeight');
      const savedAiHeight = localStorage.getItem('aiSectionsHeight');
      if (savedVideoHeight && savedAiHeight) {
        // Validate saved values
        const videoPercent = parseFloat(savedVideoHeight);
        const aiPercent = parseFloat(savedAiHeight);
        // Ensure both values are valid and reasonable (between 10% and 90%)
        if (!isNaN(videoPercent) && !isNaN(aiPercent) && 
            videoPercent >= 10 && videoPercent <= 90 && 
            aiPercent >= 10 && aiPercent <= 90) {
          document.documentElement.style.setProperty('--video-area-height', savedVideoHeight);
          document.documentElement.style.setProperty('--ai-sections-height', savedAiHeight);
        } else {
          // Clear invalid values
          localStorage.removeItem('videoAreaHeight');
          localStorage.removeItem('aiSectionsHeight');
        }
      }

      function startResizeLeftVertical(e) {
        isResizing = true;
        resizerLeftVertical.classList.add('dragging');
        
        // Get panel position
        const leftPanelRect = leftPanel.getBoundingClientRect();
        
        // Store initial resizer position relative to panel
        const resizerRect = resizerLeftVertical.getBoundingClientRect();
        startY = resizerRect.top + resizerRect.height / 2 - leftPanelRect.top;
        
        document.body.style.cursor = 'row-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      }

      let rafId = null;
      
      function resizeLeftVertical(e) {
        if (!isResizing) return;
        
        // Cancel previous animation frame
        if (rafId) {
          cancelAnimationFrame(rafId);
        }
        
        // Use requestAnimationFrame for smooth updates
        rafId = requestAnimationFrame(() => {
          const leftPanelRect = leftPanel.getBoundingClientRect();
          const avatarSection = document.querySelector('.waiting-avatar-section');
          const avatarHeight = avatarSection && avatarSection.offsetParent !== null ? avatarSection.offsetHeight : 0;
          
          // Calculate mouse position relative to panel
          const mouseY = e.clientY - leftPanelRect.top;
          const resizerHeight = 4;
          const availableHeight = leftPanelRect.height - avatarHeight - resizerHeight;
          
          // Calculate new video height based on mouse position
          let newVideoHeight = mouseY - avatarHeight;
          const minHeight = availableHeight * 0.2;
          const maxHeight = availableHeight * 0.8;
          
          // Clamp to min/max but always update to follow mouse
          newVideoHeight = Math.max(minHeight, Math.min(maxHeight, newVideoHeight));
          const newAiHeight = availableHeight - newVideoHeight;
          
          // Always update position to follow mouse
          const videoPercent = (newVideoHeight / availableHeight) * 100;
          const aiPercent = (newAiHeight / availableHeight) * 100;
          
          document.documentElement.style.setProperty('--video-area-height', `${videoPercent}%`);
          document.documentElement.style.setProperty('--ai-sections-height', `${aiPercent}%`);
        });
      }
      
      function stopResizeLeftVertical() {
        if (!isResizing) return;
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        isResizing = false;
        resizerLeftVertical.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        
        // Save to localStorage on stop
        const leftPanelRect = leftPanel.getBoundingClientRect();
        const avatarSection = document.querySelector('.waiting-avatar-section');
        const avatarHeight = avatarSection && avatarSection.offsetParent !== null ? avatarSection.offsetHeight : 0;
        const resizerHeight = 4;
        const availableHeight = leftPanelRect.height - avatarHeight - resizerHeight;
        const videoWrapper = document.querySelector('.video-area-wrapper');
        const videoRect = videoWrapper.getBoundingClientRect();
        const videoPercent = ((videoRect.height) / availableHeight) * 100;
        const aiPercent = 100 - videoPercent;
        
        localStorage.setItem('videoAreaHeight', `${videoPercent}%`);
        localStorage.setItem('aiSectionsHeight', `${aiPercent}%`);
      }

      resizerLeftVertical.addEventListener('mousedown', startResizeLeftVertical);
      document.addEventListener('mousemove', resizeLeftVertical);
      document.addEventListener('mouseup', stopResizeLeftVertical);
      document.addEventListener('mouseleave', stopResizeLeftVertical);
      
      // Ensure AI sections are visible on page load
      window.addEventListener('load', () => {
        const aiSections = document.querySelector('.ai-sections');
        if (aiSections) {
          const computedStyle = window.getComputedStyle(aiSections);
          if (computedStyle.display === 'none' || computedStyle.height === '0px') {
            // Reset to default if hidden
            document.documentElement.style.removeProperty('--ai-sections-height');
            localStorage.removeItem('aiSectionsHeight');
          }
        }
      });
    })();

    // Load doctor data
    let doctorData = {};
    try {
      const doctorDataStr = sessionStorage.getItem('doctorData');
      console.log('üîç Raw doctorData string from sessionStorage:', doctorDataStr);
      if (doctorDataStr) {
        doctorData = JSON.parse(doctorDataStr);
        console.log('üîç Parsed doctorData:', doctorData);
      } else {
        console.error('‚ùå No doctorData in sessionStorage!');
        // Check if logged in
        const isLoggedIn = sessionStorage.getItem('doctorLoggedIn');
        console.log('üîç doctorLoggedIn:', isLoggedIn);
        if (!isLoggedIn) {
          console.error('‚ùå Not logged in! Redirecting to signin...');
          window.location.href = '/signin.html';
        }
      }
    } catch (err) {
      console.error('‚ùå Error parsing doctorData:', err);
    }
    
    const doctorName = `${doctorData.first_name || ''} ${doctorData.last_name || ''}`.trim() || 'Doctor';
    const initials = (doctorData.first_name?.[0] || '') + (doctorData.last_name?.[0] || '') || 'D';

    // Update UI with doctor info
    document.getElementById('doctorName').textContent = `Dr. ${doctorName}`;
    updateAvatarDisplay(doctorData.avatar, initials);
    updateWaitingAvatarDisplay(doctorData.avatar, initials);

    // Avatar upload functionality (connected state)
    const avatarUploadInput = document.getElementById('avatarUploadInput');
    const avatarUploadBtn = document.getElementById('avatarUploadBtn');
    
    avatarUploadBtn.addEventListener('click', () => {
      avatarUploadInput.click();
    });
    
    avatarUploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('Avatar file size should be less than 5MB');
        e.target.value = '';
        return;
      }
      
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        e.target.value = '';
        return;
      }
      
      const formData = new FormData();
      formData.append('avatar', file);
      formData.append('doctor_id', doctorData.doctor_id);
      
      try {
        const res = await fetch('/api/doctors/avatar', {
          method: 'POST',
          body: formData,
        });
        
        const result = await res.json();
        if (result.success) {
          // Update sessionStorage with new avatar
          doctorData.avatar = result.doctor.avatar;
          sessionStorage.setItem('doctorData', JSON.stringify(doctorData));
          updateAvatarDisplay(result.doctor.avatar, initials);
          updateWaitingAvatarDisplay(result.doctor.avatar, initials);
          alert('Avatar updated successfully!');
        } else {
          alert('Failed to update avatar: ' + (result.message || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error uploading avatar:', err);
        alert('Network error. Please try again.');
      }
      
      e.target.value = '';
    });

    // Avatar upload functionality (waiting state)
    const waitingAvatarUploadInput = document.getElementById('waitingAvatarUploadInput');
    const waitingAvatarUploadBtn = document.getElementById('waitingAvatarUploadBtn');
    
    waitingAvatarUploadBtn.addEventListener('click', () => {
      waitingAvatarUploadInput.click();
    });
    
    waitingAvatarUploadInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('Avatar file size should be less than 5MB');
        e.target.value = '';
        return;
      }
      
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        e.target.value = '';
        return;
      }
      
      const formData = new FormData();
      formData.append('avatar', file);
      formData.append('doctor_id', doctorData.doctor_id);
      
      try {
        const res = await fetch('/api/doctors/avatar', {
          method: 'POST',
          body: formData,
        });
        
        const result = await res.json();
        if (result.success) {
          // Update sessionStorage with new avatar
          doctorData.avatar = result.doctor.avatar;
          sessionStorage.setItem('doctorData', JSON.stringify(doctorData));
          updateAvatarDisplay(result.doctor.avatar, initials);
          updateWaitingAvatarDisplay(result.doctor.avatar, initials);
          alert('Avatar updated successfully!');
        } else {
          alert('Failed to update avatar: ' + (result.message || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error uploading avatar:', err);
        alert('Network error. Please try again.');
      }
      
      e.target.value = '';
    });

    function updateAvatarDisplay(avatarUrl, initials) {
      const avatarElement = document.getElementById('doctorAvatar');
      const initialsElement = document.getElementById('avatarInitials');
      
      if (avatarUrl) {
        // Remove initials text
        initialsElement.style.display = 'none';
        // Add or update image
        let img = avatarElement.querySelector('img');
        if (!img) {
          img = document.createElement('img');
          avatarElement.insertBefore(img, initialsElement);
        }
        img.src = avatarUrl;
        img.alt = 'Doctor Avatar';
        avatarElement.style.background = 'transparent';
      } else {
        // Show initials
        initialsElement.style.display = 'flex';
        initialsElement.textContent = initials;
        // Remove image if exists
        const img = avatarElement.querySelector('img');
        if (img) img.remove();
        avatarElement.style.background = 'var(--accent)';
      }
    }

    function updateWaitingAvatarDisplay(avatarUrl, initials) {
      const avatarElement = document.getElementById('waitingAvatar');
      const initialsElement = document.getElementById('waitingAvatarInitials');
      
      if (avatarUrl) {
        // Remove initials text
        initialsElement.style.display = 'none';
        // Add or update image
        let img = avatarElement.querySelector('img');
        if (!img) {
          img = document.createElement('img');
          avatarElement.insertBefore(img, initialsElement);
        }
        img.src = avatarUrl;
        img.alt = 'Doctor Avatar';
        avatarElement.style.background = 'transparent';
      } else {
        // Show initials
        initialsElement.style.display = 'flex';
        initialsElement.textContent = initials;
        // Remove image if exists
        const img = avatarElement.querySelector('img');
        if (img) img.remove();
        avatarElement.style.background = 'var(--accent)';
      }
    }

    // State management
    let isConnected = false;

    function setState(connected) {
      isConnected = connected;
      const body = document.body;
      const videoArea = document.getElementById('videoCallArea');
      const patientImage = document.getElementById('patientImage');
      const connectedVideoContainer = document.getElementById('connectedVideoContainer');
      
      if (connected) {
        body.classList.remove('state-waiting');
        body.classList.add('state-connected');
        videoArea.classList.remove('waiting');
        videoArea.classList.add('connected');
        if (connectedVideoContainer) {
          connectedVideoContainer.style.display = 'block';
        }
        patientImage.classList.add('visible');
        
        // Update AI sections with sample data
        updateConnectedState();
      } else {
        body.classList.remove('state-connected');
        body.classList.add('state-waiting');
        videoArea.classList.remove('connected');
        videoArea.classList.add('waiting');
        if (connectedVideoContainer) {
          connectedVideoContainer.style.display = 'none';
        }
        patientImage.classList.remove('visible');
        
        // Clean up streams
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }
        // Clear video elements
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        if (localVideo) {
          localVideo.srcObject = null;
        }
        if (remoteVideo) {
          remoteVideo.srcObject = null;
        }
        
        // Reset to waiting state
        resetToWaitingState();
      }
    }

    function updateConnectedState() {
      // Update AI Real-time Interpreter
      document.getElementById('interpreterText').textContent = 
        "Doctor, my baby's been coughing and feels hot. What should I do?";
      
      // Update AI Symptom Summary
      const symptomList = document.getElementById('symptomList');
      symptomList.innerHTML = `
        <li>Mild fever (~38 ¬∞C)</li>
        <li>Continuous coughing</li>
        <li>Infant appears irritable and uncomfortable</li>
        <li>Onset within the past few hours</li>
      `;
      
      // Update AI Summary Report
      document.getElementById('reportPatient').textContent = 'Infant (approx. 2-3 months old)';
      document.getElementById('reportSymptoms').innerHTML = `
        <li>Fever around 38 ¬∞C</li>
        <li>Coughing since last night</li>
        <li>Irritability and crying</li>
      `;
      document.getElementById('reportConcern').textContent = 
        'Worried about possible infection and asking if medical attention is needed.';
      document.getElementById('reportSummary').textContent = 
        'Symptoms indicate a mild viral infection pattern; no signs of severe distress reported.';
      
      // Update Chat History
      const chatHistory = document.getElementById('chatHistory');
      chatHistory.innerHTML = `
        <div class="chat-message patient">
          <strong>Patient:</strong>
          My child has a fever of 38 degrees Celsius and a cough. What could be the cause, and what should I do?
        </div>
        <div class="chat-message ai">
          <strong>AI:</strong>
          Your child's symptoms suggest a mild viral infection ‚Äî common and usually not serious.
          <br><br>
          <strong>What You Can Do:</strong>
          <ul>
            <li>Keep them rested and hydrated.</li>
            <li>Monitor their temperature and cough.</li>
            <li>If the fever rises or symptoms worsen, seek medical attention.</li>
          </ul>
        </div>
        <div class="chat-message doctor">
          <strong>Doctor Available</strong>
          üë®‚Äç‚öïÔ∏è Dr. ${doctorName}, our pediatrician, is available now for an online consultation. Would you like me to connect you?
        </div>
      `;
    }

    function resetToWaitingState() {
      document.getElementById('interpreterText').textContent = '';
      document.getElementById('symptomList').innerHTML = '';
      document.getElementById('reportPatient').textContent = '';
      document.getElementById('reportSymptoms').innerHTML = '';
      document.getElementById('reportConcern').textContent = '';
      document.getElementById('reportSummary').textContent = '';
      document.getElementById('chatHistory').innerHTML = '';
    }

    // Control buttons
    document.getElementById('videoBtn').addEventListener('click', () => {
      const btn = document.getElementById('videoBtn');
      btn.classList.toggle('active');
      // Video toggle logic will be added here
    });

    document.getElementById('micBtn').addEventListener('click', () => {
      const btn = document.getElementById('micBtn');
      btn.classList.toggle('active');
      // Microphone toggle logic will be added here
    });

    document.getElementById('hangupBtn').addEventListener('click', () => {
      if (isConnected && confirm('End the consultation?')) {
        setState(false);
      } else if (!isConnected) {
        // Logout if not connected
        logout();
      }
    });

    // Language button
    document.getElementById('languageBtn').addEventListener('click', () => {
      const languages = ['English', '‰∏≠Êñá', 'Espa√±ol', 'Fran√ßais'];
      const current = document.getElementById('languageBtn').textContent;
      const index = languages.indexOf(current);
      const next = languages[(index + 1) % languages.length];
      document.getElementById('languageBtn').textContent = next;
    });

    // WebSocket connection for video calls
    let ws = null;
    let doctorId = null;
    let currentCallOffer = null;
    let currentCallFrom = null;
    
    // WebRTC variables
    let peerConnection = null;
    let localStream = null;
    let remoteStream = null;
    
    // Get doctor ID from the doctorData already loaded above (line ~1195-1215)
    // doctorData is already available in this scope
    console.log('üîç Getting doctorId from doctorData:', doctorData);
    console.log('üîç doctorData keys:', Object.keys(doctorData));
    // Try multiple possible field names
    doctorId = doctorData.doctor_id || doctorData.doctorId || doctorData.id || null;
    console.log('üîç Extracted doctorId:', doctorId);
    
    // If still no ID, log all keys for debugging
    if (!doctorId && Object.keys(doctorData).length > 0) {
      console.error('‚ùå Doctor ID not found! Available keys:', Object.keys(doctorData));
      console.error('‚ùå Full doctorData:', JSON.stringify(doctorData, null, 2));
    } else if (!doctorId) {
      console.error('‚ùå No doctorData found!');
      console.error('‚ùå sessionStorage doctorData:', sessionStorage.getItem('doctorData'));
      console.error('‚ùå sessionStorage doctorLoggedIn:', sessionStorage.getItem('doctorLoggedIn'));
      // Try to reload doctorData one more time
      try {
        const reloadedData = JSON.parse(sessionStorage.getItem('doctorData') || '{}');
        console.log('üîÑ Reloaded doctorData:', reloadedData);
        doctorId = reloadedData.doctor_id || reloadedData.doctorId || reloadedData.id || null;
        if (doctorId) {
          console.log('‚úÖ Found doctorId after reload:', doctorId);
        }
      } catch (e) {
        console.error('‚ùå Error reloading doctorData:', e);
      }
    }
    
    function connectWebSocket() {
      if (!doctorId) {
        console.log('‚ö†Ô∏è No doctor ID, cannot connect WebSocket');
        console.log('Doctor data:', doctorData);
        return;
      }
      
      console.log('üîå Connecting WebSocket with doctor ID:', doctorId);
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;
      console.log('üîó WebSocket URL:', wsUrl);
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = () => {
        console.log('‚úÖ WebSocket connected');
        console.log('üîç About to register with doctorId:', doctorId);
        // Update status display
        const wsStatusEl = document.getElementById('displayWsStatus');
        if (wsStatusEl) wsStatusEl.textContent = 'Connected';
        
        if (!doctorId) {
          console.error('‚ùå Cannot register: doctorId is null or undefined!');
          if (wsStatusEl) wsStatusEl.textContent = 'Error: No Doctor ID';
          return;
        }
        
        // Register with doctor ID
        const registerMsg = {
          type: 'register',
          id: String(doctorId) // Ensure it's a string
        };
        console.log('üì§ Sending register message:', JSON.stringify(registerMsg, null, 2));
        try {
          ws.send(JSON.stringify(registerMsg));
          console.log('‚úÖ Register message sent successfully');
        } catch (err) {
          console.error('‚ùå Error sending register message:', err);
        }
      };
      
      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          console.log('üì® WebSocket message received:', JSON.stringify(msg, null, 2));
          
          if (msg.type === 'registered') {
            console.log('‚úÖ Registered with WebSocket, ID:', msg.id);
            // Update status display
            const wsStatusEl = document.getElementById('displayWsStatus');
            if (wsStatusEl) wsStatusEl.textContent = `Registered (${msg.id})`;
            // Update doctor ID display if it was different
            if (msg.id !== doctorId) {
              console.log('‚ö†Ô∏è Registered ID differs from expected:', msg.id, 'vs', doctorId);
            }
          } else if (msg.type === 'signal') {
            console.log('üì° Signal received from:', msg.from, 'to:', msg.to, 'payload:', msg.payload);
            
            // Check if this signal is for us
            if (msg.to && msg.to !== doctorId) {
              console.log('‚ö†Ô∏è Signal not for this doctor, ignoring');
              return;
            }
            
            if (msg.payload) {
              // Check if this is an incoming call (offer)
              if (msg.payload.offer) {
                console.log('üìû Incoming call offer detected!');
                handleIncomingCall(msg.from, msg.payload.offer);
              } else if (msg.payload.answer) {
                // Answer received (shouldn't happen for doctor, but handle it)
                console.log('üì® Answer received');
              } else if (msg.payload.candidate) {
                // ICE candidate received
                console.log('üßä ICE candidate received');
                if (peerConnection) {
                  try {
                    const candidate = new RTCIceCandidate({
                      candidate: msg.payload.candidate.candidate,
                      sdpMLineIndex: msg.payload.candidate.sdpMLineIndex,
                      sdpMid: msg.payload.candidate.sdpMid
                    });
                    await peerConnection.addIceCandidate(candidate);
                    console.log('‚úÖ ICE candidate added');
                  } catch (error) {
                    console.error('‚ùå Error adding ICE candidate:', error);
                  }
                } else {
                  console.warn('‚ö†Ô∏è PeerConnection not ready for ICE candidate');
                }
              } else if (msg.payload.reject) {
                console.log('‚ùå Call rejected by caller');
              }
            }
          } else {
            console.log('üì® Unknown message type:', msg.type);
          }
        } catch (err) {
          console.error('‚ùå Error parsing WebSocket message:', err);
          console.error('Raw message:', event.data);
        }
      };
      
      ws.onerror = (error) => {
        console.error('‚ùå WebSocket error:', error);
        console.error('‚ùå WebSocket error details:', JSON.stringify(error, null, 2));
      };
      
      ws.onclose = (event) => {
        console.log('üì¥ WebSocket closed');
        console.log('üì¥ Close code:', event.code);
        console.log('üì¥ Close reason:', event.reason);
        console.log('üì¥ Was clean:', event.wasClean);
        // Update status display
        const wsStatusEl = document.getElementById('displayWsStatus');
        if (wsStatusEl) wsStatusEl.textContent = 'Disconnected';
        // Reconnect after 3 seconds (only if we have a doctorId)
        if (doctorId) {
          console.log('üîÑ Reconnecting in 3 seconds...');
          setTimeout(connectWebSocket, 3000);
        } else {
          console.error('‚ùå Cannot reconnect: no doctorId');
        }
      };
    }
    
    function handleIncomingCall(from, offer) {
      console.log('üìû Incoming call from:', from);
      console.log('üìû Offer data:', offer);
      currentCallOffer = offer;
      currentCallFrom = from;
      
      // Show incoming call notification
      const overlay = document.getElementById('incomingCallOverlay');
      const nameEl = document.getElementById('incomingCallName');
      const statusEl = document.getElementById('incomingCallStatus');
      
      if (!overlay || !nameEl || !statusEl) {
        console.error('‚ùå Incoming call UI elements not found!');
        return;
      }
      
      // Set caller info (you can fetch parent info from API if needed)
      nameEl.textContent = 'Parent Calling';
      statusEl.textContent = 'Incoming video call...';
      
      overlay.style.display = 'flex';
      console.log('‚úÖ Incoming call overlay displayed');
    }
    
    async function acceptCall() {
      if (!currentCallOffer || !currentCallFrom) {
        console.error('‚ùå No call offer to accept');
        return;
      }
      
      console.log('‚úÖ Accepting call from:', currentCallFrom);
      
      // Hide incoming call overlay
      document.getElementById('incomingCallOverlay').style.display = 'none';
      
      try {
        // Get local media stream (camera and microphone)
        console.log('üé• Requesting local media stream...');
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });
        console.log('‚úÖ Local media stream obtained');
        
        // Display local video
        const localVideo = document.getElementById('localVideo');
        if (localVideo) {
          localVideo.srcObject = localStream;
          localVideo.play();
          console.log('‚úÖ Local video displayed');
        }
        
        // Create RTCPeerConnection
        const configuration = {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        };
        peerConnection = new RTCPeerConnection(configuration);
        console.log('‚úÖ RTCPeerConnection created');
        
        // Add local stream tracks to peer connection
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
          console.log('‚úÖ Added local track:', track.kind);
        });
        
        // Handle remote stream
        peerConnection.ontrack = (event) => {
          console.log('üìπ Remote track received:', event.track.kind);
          remoteStream = event.streams[0];
          const remoteVideo = document.getElementById('remoteVideo');
          if (remoteVideo) {
            remoteVideo.srcObject = remoteStream;
            remoteVideo.play();
            console.log('‚úÖ Remote video displayed');
          }
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            console.log('üßä Sending ICE candidate');
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({
                type: 'signal',
                from: doctorId,
                to: currentCallFrom,
                payload: {
                  candidate: {
                    candidate: event.candidate.candidate,
                    sdpMLineIndex: event.candidate.sdpMLineIndex,
                    sdpMid: event.candidate.sdpMid
                  }
                }
              }));
            }
          }
        };
        
        // Set remote description (offer)
        console.log('üì• Setting remote description (offer)...');
        await peerConnection.setRemoteDescription(new RTCSessionDescription(currentCallOffer));
        console.log('‚úÖ Remote description set');
        
        // Create answer
        console.log('üì§ Creating answer...');
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        console.log('‚úÖ Answer created and set as local description');
        
        // Send answer
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'signal',
            from: doctorId,
            to: currentCallFrom,
            payload: {
              answer: {
                type: 'answer',
                sdp: answer.sdp
              }
            }
          }));
          console.log('‚úÖ Answer sent');
        }
        
        // Set state to connected
        setState(true);
        
        // Clear call data
        currentCallOffer = null;
        currentCallFrom = null;
      } catch (error) {
        console.error('‚ùå Error accepting call:', error);
        alert('Failed to accept call: ' + error.message);
      }
    }
    
    function rejectCall() {
      console.log('‚ùå Rejecting call from:', currentCallFrom);
      
      // Hide incoming call overlay
      document.getElementById('incomingCallOverlay').style.display = 'none';
      
      // Send rejection signal (optional)
      if (ws && ws.readyState === WebSocket.OPEN && currentCallFrom) {
        ws.send(JSON.stringify({
          type: 'signal',
          from: doctorId,
          to: currentCallFrom,
          payload: {
            reject: true
          }
        }));
      }
      
      // Clear call data
      currentCallOffer = null;
      currentCallFrom = null;
    }
    
    // Setup call buttons
    document.getElementById('acceptCallBtn').addEventListener('click', acceptCall);
    document.getElementById('rejectCallBtn').addEventListener('click', rejectCall);
    
    // Display doctor ID on page
    const displayDoctorIdEl = document.getElementById('displayDoctorId');
    if (displayDoctorIdEl) {
      displayDoctorIdEl.textContent = doctorId || 'Not found';
    }
    
    // Connect WebSocket on page load
    console.log('üîç Initial check - doctorId:', doctorId);
    console.log('üîç Initial check - doctorData:', doctorData);
    
    if (doctorId) {
      console.log('‚úÖ Doctor ID found, connecting WebSocket...');
      connectWebSocket();
    } else {
      console.error('‚ùå No doctor ID found! Cannot connect WebSocket.');
      console.error('SessionStorage doctorData:', sessionStorage.getItem('doctorData'));
      // Try to get doctor data from signin page
      const urlParams = new URLSearchParams(window.location.search);
      const doctorIdParam = urlParams.get('doctor_id');
      if (doctorIdParam) {
        console.log('üìù Found doctor_id in URL params:', doctorIdParam);
        doctorId = doctorIdParam;
        if (displayDoctorIdEl) displayDoctorIdEl.textContent = doctorId;
        connectWebSocket();
      } else {
        // Update status to show error
        const wsStatusEl = document.getElementById('displayWsStatus');
        if (wsStatusEl) wsStatusEl.textContent = 'No Doctor ID';
      }
    }
    
    // Also try to connect when page becomes visible (in case doctor logs in after page load)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && !ws && doctorId) {
        console.log('üëÅÔ∏è Page became visible, reconnecting WebSocket...');
        connectWebSocket();
      }
    });

    // Function to simulate call connection (for testing)
    window.simulateCall = function() {
      setState(true);
    };
    
    // Debug function to check WebSocket status
    window.checkWebSocketStatus = function() {
      console.log('üîç WebSocket Status Check:');
      console.log('  - Doctor ID:', doctorId);
      console.log('  - WebSocket object:', ws);
      console.log('  - WebSocket readyState:', ws ? ws.readyState : 'null');
      console.log('  - WebSocket URL:', ws ? ws.url : 'null');
      console.log('  - Current call offer:', currentCallOffer);
      console.log('  - Current call from:', currentCallFrom);
      console.log('  - Available peers on server (check server logs)');
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        console.log('‚úÖ WebSocket is OPEN and ready');
      } else if (ws && ws.readyState === WebSocket.CONNECTING) {
        console.log('‚è≥ WebSocket is CONNECTING...');
      } else if (ws && ws.readyState === WebSocket.CLOSING) {
        console.log('üì¥ WebSocket is CLOSING...');
      } else if (ws && ws.readyState === WebSocket.CLOSED) {
        console.log('‚ùå WebSocket is CLOSED');
      } else {
        console.log('‚ùå WebSocket is not initialized');
      }
    };
    
    // Make checkWebSocketStatus available globally
    console.log('üí° Debug: Call window.checkWebSocketStatus() in console to check WebSocket status');

    // Function to end call
    window.endCall = function() {
      // Stop all tracks
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      // Close peer connection
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
      // Clear video elements
      const localVideo = document.getElementById('localVideo');
      const remoteVideo = document.getElementById('remoteVideo');
      if (localVideo) {
        localVideo.srcObject = null;
      }
      if (remoteVideo) {
        remoteVideo.srcObject = null;
      }
      setState(false);
    };

    function logout() {
      if (ws) {
        ws.close();
      }
      sessionStorage.removeItem('doctorLoggedIn');
      sessionStorage.removeItem('doctorData');
      window.location.href = '/signin.html';
    }

    // Initialize to waiting state
    setState(false);
  </script>
</body>
</html>
