<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Doctor Console</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #111; color: #fff; }
    video { width: 40%; border: 2px solid #fff; margin: 10px; }
    button { padding: 10px 20px; margin: 5px; font-size: 16px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>üë©‚Äç‚öïÔ∏è Doctor Video Console</h2>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video><br>
  <button id="btnAnswer" disabled>Êé•Âê¨</button>
  <button id="btnHangup" disabled>ÊåÇÊñ≠</button>

  <script>
    const wsUrl = "wss://parentdoctorserver.onrender.com/ws";
    const ws = new WebSocket(wsUrl);
    let pc, currentCaller = null, localStream;

    ws.onopen = () => {
      console.log("‚úÖ WebSocket connected");
      ws.send(JSON.stringify({ type: "register", role: "doctor", id: "doctor" }));
    };

    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);
      console.log("üì© Received:", msg);

      if (msg.type === "signal" && msg.payload?.type === "offer") {
        currentCaller = msg.from;
        document.getElementById("btnAnswer").disabled = false;
        alert("üìû Êúâ‰∏Ä‰∏™Êù•ÁîµÔºÅÁÇπÂáª‚ÄúÊé•Âê¨‚ÄùÂºÄÂßãËßÜÈ¢ëÈÄöËØù");
        window.offer = msg.payload;
      }

      if (msg.type === "signal" && msg.payload?.type === "candidate" && pc) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(msg.payload.candidate));
        } catch (err) {
          console.warn("‚ö†Ô∏è addIceCandidate error", err);
        }
      }
    };

    document.getElementById("btnAnswer").onclick = async () => {
      document.getElementById("btnAnswer").disabled = true;
      document.getElementById("btnHangup").disabled = false;
      await startAnswer();
    };

    document.getElementById("btnHangup").onclick = () => {
      if (pc) pc.close();
      document.getElementById("btnHangup").disabled = true;
      alert("üõë ÈÄöËØùÁªìÊùü");
    };

    async function startAnswer() {
      pc = new RTCPeerConnection();

      pc.onicecandidate = e => {
        if (e.candidate && currentCaller) {
          ws.send(JSON.stringify({
            type: "signal",
            from: "doctor",
            to: currentCaller,
            payload: { type: "candidate", candidate: e.candidate }
          }));
        }
      };

      pc.ontrack = e => {
        document.getElementById("remoteVideo").srcObject = e.streams[0];
      };

      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      document.getElementById("localVideo").srcObject = localStream;

      await pc.setRemoteDescription(new RTCSessionDescription(window.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      ws.send(JSON.stringify({
        type: "signal",
        from: "doctor",
        to: currentCaller,
        payload: { type: "answer", sdp: answer.sdp }
      }));

      console.log("‚úÖ Sent answer to:", currentCaller);
    }
  </script>
</body>
</html>
