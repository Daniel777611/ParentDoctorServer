<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ‘©â€âš•ï¸ Doctor Video Console</title>
  <style>
    :root { --bg:#0f0f10; --panel:#16181c; --ink:#e8eaed; --muted:#9aa0a6; --ok:#16a34a; --warn:#ef4444; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    video{width:100%;background:#000;border-radius:12px}
    .panel{background:#16181c;border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 16px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.green{background:var(--ok);color:#fff}
    .btn.red{background:var(--warn);color:#fff}
    .log{height:180px;overflow:auto;font:12px/1.5 ui-monospace,Menlo,Consolas;background:#0b0c0f;border-radius:10px;padding:10px;color:#cbd5e1}
    .meter{height:10px;background:#1f2430;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:8%;background:linear-gradient(90deg,#22c55e,#eab308 70%,#ef4444);transition:width .06s linear}
    .label{min-width:92px;color:#9aa0a6;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ‘©â€âš•ï¸ Doctor Video Console</h1>
  <div class="grid">
    <div>
      <video id="localVideo" autoplay playsinline muted></video>
      <div class="panel">
        <div class="row" style="margin-bottom:8px">
          <span class="label">æœ¬åœ°éº¦å…‹é£</span>
          <div class="meter" style="flex:1"><div id="localBar" class="bar"></div></div>
        </div>
        <div class="row" style="margin-bottom:4px">
          <span class="label">æœ¬åœ°æ‘„åƒå¤´</span>
          <button id="btnStart" class="btn">å¯ç”¨è®¾å¤‡</button>
        </div>
        <div class="row" style="gap:12px">
          <button id="btnAccept" class="btn green" disabled>æ¥å¬</button>
          <button id="btnHangup" class="btn red" disabled>æŒ‚æ–­</button>
        </div>
      </div>
    </div>

    <div>
      <video id="remoteVideo" autoplay playsinline></video>
      <div class="panel">
        <div class="row" style="margin-bottom:8px">
          <span class="label">è¿œç«¯éº¦å…‹é£</span>
          <div class="meter" style="flex:1"><div id="remoteBar" class="bar"></div></div>
        </div>
        <div class="log" id="log"></div>
        <div style="color:#9aa0a6;font-size:12px;margin-top:8px">
          WS ä¸ WebRTC éƒ½åœ¨æœ¬é¡µå®Œæˆã€‚è‹¥é»‘å±ï¼Œè¯·ç¡®è®¤æµè§ˆå™¨å·²å…è®¸ç›¸æœº/éº¦å…‹é£æƒé™ã€‚
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const log = (t)=>{ const el=$("#log"); el.innerHTML += t+"<br/>"; el.scrollTop=el.scrollHeight; };

let ws, pc, localStream, remoteStream;
let localMeter = null, remoteMeter = null;
let pendingOffer = null;

const wsURL = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws";
const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

function mkPeer() {
  pc = new RTCPeerConnection(rtcConfig);

  pc.onicecandidate = (e)=>{
    if (e.candidate) {
      // âœ… ç»Ÿä¸€ signal åŒ…è£…
      ws.send(JSON.stringify({
        type:"signal",
        from:"doctor",
        to:"parent",
        payload:{ candidate: e.candidate }
      }));
    }
  };

  pc.ontrack = (e)=>{
    if (!remoteStream) {
      remoteStream = new MediaStream();
      $("#remoteVideo").srcObject = remoteStream;
      setupRemoteMeter(remoteStream);
    }
    remoteStream.addTrack(e.track);
  };

  pc.onconnectionstatechange = ()=> log("ğŸ”— PC state: " + pc.connectionState);
}

async function startLocal() {
  if (localStream) return;
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30,max:30} },
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
    });
    $("#localVideo").srcObject = localStream;
    mkPeer();
    for (const t of localStream.getTracks()) pc.addTrack(t, localStream);
    setupLocalMeter(localStream);
    $("#btnStart").disabled = true;
    log("ğŸ¥ Local stream ready, waiting for Offerâ€¦");
  } catch(err){
    log("âŒ getUserMedia error: " + err.message);
    alert("éœ€è¦ç›¸æœº/éº¦å…‹é£æƒé™");
  }
}

function setupLocalMeter(stream){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const src = ctx.createMediaStreamSource(stream);
  const analyser = ctx.createAnalyser();
  analyser.fftSize = 1024; src.connect(analyser);
  const bar = $("#localBar");
  (function tick(){
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);
    let sum=0; for(let i=0;i<buf.length;i++) sum += buf[i]*buf[i];
    const rms = Math.sqrt(sum/buf.length);
    bar.style.width = (Math.min(1, rms*4)*100).toFixed(1)+"%";
    requestAnimationFrame(tick);
  })();
  localMeter = {ctx, analyser};
}

function setupRemoteMeter(rStream){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const src = ctx.createMediaStreamSource(rStream);
  const analyser = ctx.createAnalyser();
  analyser.fftSize = 1024; src.connect(analyser);
  const bar = $("#remoteBar");
  (function tick(){
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);
    let sum=0; for(let i=0;i<buf.length;i++) sum += buf[i]*buf[i];
    const rms = Math.sqrt(sum/buf.length);
    bar.style.width = (Math.min(1, rms*4)*100).toFixed(1)+"%";
    requestAnimationFrame(tick);
  })();
  remoteMeter = {ctx, analyser};
}

function connectWS(){
  ws = new WebSocket(wsURL);
  ws.onopen = ()=>{
    ws.send(JSON.stringify({type:"register", id:"doctor"}));
    log("ğŸ”Œ WS connected: "+wsURL);
  };
  ws.onmessage = async (ev)=>{
    const msg = JSON.parse(ev.data||"{}");

    // âœ… åªå¤„ç†æœåŠ¡å™¨è½¬å‘çš„ {type:"signal", payload:{ offer|candidate|answer }}
    if (msg.type !== "signal") return;
    const p = msg.payload || {};

    if (p.offer) {                                   // æ”¶åˆ° iOS çš„ Offer
      log("ğŸ“© Offer received from parent");
      pendingOffer = p.offer.sdp;
      $("#btnAccept").disabled = false;
    } else if (p.candidate) {                        // æ”¶åˆ°å¯¹ç«¯ ICE
      try { await pc.addIceCandidate(new RTCIceCandidate(p.candidate)); }
      catch(e){ log("âŒ addIceCandidate error: "+e.message); }
    } else if (p.answer) {
      // åŒ»ç”Ÿç«¯é€šå¸¸ä¸ä¼šæ”¶åˆ° answerï¼Œè¿™é‡Œä»…æ‰“å°
      log("â„¹ï¸ Unexpected answer on doctor side");
    }
  };
  ws.onclose = ()=> log("ğŸ”Œ WS closed");
}

async function acceptCall(){
  $("#btnAccept").disabled = true;
  $("#btnHangup").disabled  = false;
  if (!localStream) await startLocal();
  if (!pc) mkPeer();

  try{
    await pc.setRemoteDescription({type:"offer", sdp: pendingOffer});
    log("ğŸ“¥ setRemoteDescription(offer)");
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    // âœ… ç»Ÿä¸€ signal åŒ…è£…å‘é€ç»™ iOS
    ws.send(JSON.stringify({
      type:"signal",
      from:"doctor",
      to:"parent",
      payload:{ answer:{ type:"answer", sdp: answer.sdp } }
    }));
    log("ğŸ“¤ Answer sent to parent");
  }catch(e){ log("âŒ Answer flow error: "+e.message); }
}

function hangup(){
  $("#btnAccept").disabled = true;
  $("#btnHangup").disabled  = true;

  try { ws && ws.close(); }catch{}
  if (pc){ pc.getSenders().forEach(s=>s.track && s.track.stop()); pc.close(); pc=null; }
  if (localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
  if (localMeter){ localMeter.ctx.close(); localMeter=null; }
  if (remoteMeter){ remoteMeter.ctx.close(); remoteMeter=null; }
  $("#localVideo").srcObject = null;
  $("#remoteVideo").srcObject = null;
  connectWS(); // ç­‰ä¸‹ä¸€æ¬¡é€šè¯
}

$("#btnStart").onclick = startLocal;
$("#btnAccept").onclick = acceptCall;
$("#btnHangup").onclick = hangup;

connectWS();     // è¿›å…¥é¡µå³è¿æ¥
startLocal();    // å…è®¸åå…ˆå‡†å¤‡æœ¬åœ°æµï¼Œæ¥ Offer æ›´å¿«
</script>
</body>
</html>
