<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Instant Doctor Console</title>
<style>
  body { font-family: Arial, sans-serif; background:#f4f7fb; text-align:center; padding-top:20px;}
  video { width:320px; height:240px; background:#000; margin:10px; border-radius:10px;}
  #status { color:green; font-weight:bold; margin-top:15px;}
  .container { display:flex; justify-content:center; align-items:center; gap:20px;}
</style>
</head>
<body>
  <h2>üë©‚Äç‚öïÔ∏è Doctor Video Console</h2>
  <div class="container">
    <video id="local" autoplay playsinline muted></video>
    <video id="remote" autoplay playsinline></video>
  </div>
  <div id="status">Waiting for patient connection...</div>

<script>
  const doctorId = "doctor1";
  const wsURL = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws";
  const ws = new WebSocket(wsURL);

  ws.addEventListener("open", () => {
    ws.send(JSON.stringify({ type: "register", id: doctorId }));
    console.log("‚úÖ WS connected:", wsURL);
  });

  const pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  const localVideo = document.getElementById("local");
  const remoteVideo = document.getElementById("remote");

  navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
      localVideo.srcObject = stream;
      stream.getTracks().forEach(t => pc.addTrack(t, stream));
    })
    .catch(err => alert("Camera access failed: " + err));

  pc.ontrack = e => {
    remoteVideo.srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    if (e.candidate) {
      ws.send(JSON.stringify({
        type: "signal",
        from: doctorId,
        to: "parent",
        payload: { candidate: e.candidate }
      }));
    }
  };

  ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);
    console.log("üì®", msg);

    if (msg.type !== "signal" || msg.to !== doctorId || !msg.payload) return;

    if (msg.payload.offer) {
      await pc.setRemoteDescription(new RTCSessionDescription(msg.payload.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({
        type: "signal",
        from: doctorId,
        to: msg.from,
        payload: { answer }
      }));
      document.getElementById("status").innerText = "üü¢ Connected to patient!";
    } else if (msg.payload.candidate) {
      await pc.addIceCandidate(new RTCIceCandidate(msg.payload.candidate));
    }
  };
</script>
</body>
</html>
