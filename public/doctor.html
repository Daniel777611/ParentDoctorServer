<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ‘©â€âš•ï¸ Doctor Video Console</title>
  <style>
    :root { --bg:#0f0f10; --panel:#16181c; --ink:#e8eaed; --muted:#9aa0a6; --ok:#16a34a; --warn:#ef4444; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    video{width:100%;background:#000;border-radius:12px}
    .panel{background:#16181c;border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 16px;border:0;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.green{background:var(--ok);color:#fff}
    .btn.red{background:var(--warn);color:#fff}
    .log{height:200px;overflow:auto;font:12px/1.5 ui-monospace,Menlo,Consolas;background:#0b0c0f;border-radius:10px;padding:10px;color:#cbd5e1}
    .meter{height:10px;background:#1f2430;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:8%;background:linear-gradient(90deg,#22c55e,#eab308 70%,#ef4444);transition:width .06s linear}
    .label{min-width:92px;color:#9aa0a6;font-size:12px}
    select.btn{padding:8px 10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ‘©â€âš•ï¸ Doctor Video Console</h1>
  <div class="grid">
    <div>
      <video id="localVideo" autoplay playsinline muted></video>
      <div class="panel">
        <div class="row" style="margin-bottom:8px">
          <span class="label">æœ¬åœ°éº¦å…‹é£</span>
          <div class="meter" style="flex:1"><div id="localBar" class="bar"></div></div>
        </div>
        <div class="row" style="margin-bottom:6px">
          <span class="label">æœ¬åœ°æ‘„åƒå¤´</span>
          <button id="btnStart" class="btn">å¯ç”¨è®¾å¤‡</button>
        </div>
        <div class="row" style="gap:12px">
          <button id="btnAccept" class="btn green" disabled>æ¥å¬</button>
          <button id="btnHangup" class="btn red" disabled>æŒ‚æ–­</button>
        </div>
      </div>
    </div>

    <div>
      <video id="remoteVideo" autoplay playsinline></video>
      <div class="panel">
        <div class="row" style="margin-bottom:8px">
          <span class="label">è¿œç«¯éº¦å…‹é£</span>
          <div class="meter" style="flex:1"><div id="remoteBar" class="bar"></div></div>
        </div>

        <!-- è¾“å‡ºè®¾å¤‡é€‰æ‹©ï¼ˆéœ€è¦ HTTPSï¼›Chrome/Edge æ”¯æŒ setSinkIdï¼‰ -->
        <div class="row" style="margin-bottom:6px">
          <span class="label">è¾“å‡ºè®¾å¤‡</span>
          <select id="outSel" class="btn" style="background:#222;color:#fff"></select>
        </div>

        <div class="log" id="log"></div>
        <div style="color:#9aa0a6;font-size:12px;margin-top:8px">
          è‹¥é»‘å±/å¡é¡¿/æ— å£°ï¼šæ£€æŸ¥æµè§ˆå™¨ç›¸æœºä¸éº¦å…‹é£æƒé™ï¼›ç¡®ä¿æœªé™éŸ³æ ‡ç­¾ï¼›å…¬å¸ç½‘ç»œå¯èƒ½é™åˆ¶ UDP/TCP 443ã€‚
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const log = (t)=>{ const el=$("#log"); el.innerHTML += t+"<br/>"; el.scrollTop=el.scrollHeight; };

// ---- State
let ws, pc, localStream, remoteStream;
let localMeter = null, remoteMeter = null;
let pendingOffer = null;
let remoteDescSet = false;
const pendingRemoteCandidates = [];
let outSelEl = null;

// ---- Config
const wsURL = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws";
const rtcConfig = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    { urls: "turn:global.relay.metered.ca:80", username: "open", credential: "open" },
    { urls: "turn:global.relay.metered.ca:443?transport=tcp", username: "open", credential: "open" },
    { urls: "turns:global.relay.metered.ca:443?transport=tcp", username: "open", credential: "open" }
  ]
};

// ---- Peer
function ensurePeer() {
  if (pc) return;
  pc = new RTCPeerConnection(rtcConfig);

  pc.onicecandidate = (e)=>{
    if (e.candidate) {
      ws.send(JSON.stringify({
        type:"signal", from:"doctor", to:"parent",
        payload:{ candidate: e.candidate }
      }));
    }
  };

  pc.ontrack = (e)=>{
    if (!remoteStream) {
      remoteStream = new MediaStream();
      const v = $("#remoteVideo");
      v.srcObject = remoteStream;
      v.muted = false;           // âœ… ä¸é™éŸ³
      v.volume = 1.0;
      v.autoplay = true;
      v.playsInline = true;
      v.play().catch(()=>{});    // âœ… å¼ºåˆ¶æ’­æ”¾
      setupRemoteMeter(remoteStream);
    }
    remoteStream.addTrack(e.track);
  };

  pc.onconnectionstatechange = ()=>{
    log("ğŸ”— PC state: " + pc.connectionState);
  };
}

// ---- Local media
async function startLocal() {
  if (localStream) return;
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30,max:30} },
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
    });
    $("#localVideo").srcObject = localStream;
    setupLocalMeter(localStream);
    ensurePeer();
    for (const t of localStream.getTracks()) {
      const sender = pc.addTrack(t, localStream);
      // æ§åˆ¶ç½‘é¡µç«¯ä¸Šè¡Œç ç‡ï¼ˆé¿å…æ‹¥å¡ï¼‰
      if (t.kind === "video" && sender.getParameters) {
        const p = sender.getParameters();
        p.encodings = p.encodings || [{}];
        p.encodings[0].maxBitrate = 1_200_000; // ~1.2Mbps
        sender.setParameters(p).catch(()=>{});
      }
    }
    $("#btnStart").disabled = true;
    log("ğŸ¥ Local stream ready.");
  } catch(err){
    log("âŒ getUserMedia error: " + err.message);
    alert("éœ€è¦ç›¸æœº/éº¦å…‹é£æƒé™");
  }
}

function setupLocalMeter(stream){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const src = ctx.createMediaStreamSource(stream);
  const analyser = ctx.createAnalyser();
  analyser.fftSize = 1024; src.connect(analyser);
  const bar = $("#localBar");
  (function tick(){
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);
    let sum=0; for(let i=0;i<buf.length;i++) sum += buf[i]*buf[i];
    const rms = Math.sqrt(sum/buf.length);
    bar.style.width = (Math.min(1, rms*4)*100).toFixed(1)+"%";
    requestAnimationFrame(tick);
  })();
  localMeter = {ctx, analyser};
}

function setupRemoteMeter(rStream){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const src = ctx.createMediaStreamSource(rStream);
  const analyser = ctx.createAnalyser();
  analyser.fftSize = 1024; src.connect(analyser);
  const bar = $("#remoteBar");
  (function tick(){
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);
    let sum=0; for(let i=0;i<buf.length;i++) sum += buf[i]*buf[i];
    const rms = Math.sqrt(sum/buf.length);
    bar.style.width = (Math.min(1, rms*4)*100).toFixed(1)+"%";
    requestAnimationFrame(tick);
  })();
  remoteMeter = {ctx, analyser};
}

// ---- WebSocket
function connectWS(){
  if (ws) try { ws.close(); } catch {}
  ws = new WebSocket(wsURL);
  ws.onopen = ()=>{
    ws.send(JSON.stringify({type:"register", id:"doctor"}));
    log("ğŸ”Œ WS connected: "+wsURL);
  };
  ws.onmessage = async (ev)=>{
    const msg = JSON.parse(ev.data||"{}");
    if (msg.type !== "signal") return;
    const p = msg.payload || {};

    if (p.offer) {
      pendingOffer = p.offer.sdp;
      $("#btnAccept").disabled = false;
      log("ğŸ“© Offer received from parent");
      return;
    }

    if (p.candidate) {
      if (!remoteDescSet) {
        pendingRemoteCandidates.push(p.candidate);
        log("ğŸ§Š queued remote candidate");
      } else {
        try { await pc.addIceCandidate(new RTCIceCandidate(p.candidate)); }
        catch(e){ log("âŒ addIceCandidate error: " + e.message); }
      }
      return;
    }
  };
}

// ---- Call control
async function acceptCall(){
  $("#btnAccept").disabled = true;
  $("#btnHangup").disabled = false;
  await startLocal(); // ç”¨æˆ·æ‰‹åŠ¿è§¦å‘ï¼Œè§£é”éŸ³é¢‘ç­–ç•¥
  ensurePeer();

  try{
    await pc.setRemoteDescription({type:"offer", sdp: pendingOffer});
    remoteDescSet = true;
    log("ğŸ“¥ setRemoteDescription(offer)");

    while (pendingRemoteCandidates.length) {
      const c = pendingRemoteCandidates.shift();
      try { await pc.addIceCandidate(new RTCIceCandidate(c)); }
      catch(e){ log("âŒ flush candidate error: " + e.message); }
    }

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({
      type:"signal", from:"doctor", to:"parent",
      payload:{ answer:{ type:"answer", sdp: answer.sdp } }
    }));
    log("ğŸ“¤ Answer sent to parent");

    // è§£é”éŸ³é¢‘å¹¶å¼ºåˆ¶æ’­æ”¾
    await resumeAudio();
    $("#remoteVideo").play().catch(()=>{});
  }catch(e){ log("âŒ accept flow error: " + e.message); }
}

function hangup(){
  $("#btnAccept").disabled = true;
  $("#btnHangup").disabled = true;
  remoteDescSet = false;
  pendingRemoteCandidates.length = 0;
  if (pc) { try { pc.close(); } catch{} pc = null; }
  if (localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
  if (localMeter){ localMeter.ctx.close(); localMeter=null; }
  if (remoteMeter){ remoteMeter.ctx.close(); remoteMeter=null; }
  $("#localVideo").srcObject = null;
  $("#remoteVideo").srcObject = null;
  connectWS();
}

// ---- Helpers: éŸ³é¢‘è§£é” & è¾“å‡ºè®¾å¤‡
async function resumeAudio() {
  try { await localMeter?.ctx?.resume?.(); } catch {}
  try { await remoteMeter?.ctx?.resume?.(); } catch {}
  try { await $("#remoteVideo").play(); } catch {}
}
document.addEventListener("click", resumeAudio, { once:true });
document.addEventListener("keydown", resumeAudio, { once:true });

async function listOutputs() {
  outSelEl = $("#outSel");
  if (!outSelEl) return;
  const v = $("#remoteVideo");

  const devs = await navigator.mediaDevices.enumerateDevices();
  const outs = devs.filter(d => d.kind === "audiooutput");
  outSelEl.innerHTML = "";
  outs.forEach((d, i) => {
    const opt = document.createElement("option");
    opt.value = d.deviceId;
    opt.text  = d.label || `æ‰¬å£°å™¨ ${i+1}`;
    outSelEl.appendChild(opt);
  });

  if (typeof v.setSinkId === "function") {
    try { await v.setSinkId("default"); } catch {}
    outSelEl.onchange = async (e) => {
      try {
        await v.setSinkId(e.target.value || "default");
        log("ğŸ”Š è¾“å‡ºè®¾å¤‡ï¼š" + (e.target.selectedOptions[0]?.text || e.target.value));
      } catch(err) {
        log("âŒ setSinkId å¤±è´¥ï¼š" + err.message);
      }
    };
  } else {
    log("â„¹ï¸ æµè§ˆå™¨ä¸æ”¯æŒé€‰æ‹©éŸ³é¢‘è¾“å‡ºè®¾å¤‡ï¼ˆsetSinkIdï¼‰ã€‚");
    outSelEl.disabled = true;
  }
}
navigator.mediaDevices?.addEventListener?.("devicechange", listOutputs);

// æ ‡ç­¾é¡µå›åˆ°å‰å°æ—¶å°è¯•æ¢å¤æ’­æ”¾
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) { $("#remoteVideo").play().catch(()=>{}); }
});

// ---- Bind UI & start
$("#btnStart").onclick = startLocal;
$("#btnAccept").onclick = acceptCall;
$("#btnHangup").onclick = hangup;

connectWS();
listOutputs();
</script>
</body>
</html>
